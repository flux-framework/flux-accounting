.NOTPARALLEL:

SUBDIRS = . test

MAN_FILES = $(MAN1_FILES)

MAN1_FILES = $(MAN1_FILES_PRIMARY)

MAN1_FILES_PRIMARY = \
	man1/flux-account.1 \
	man1/flux-account-create-db.1 \
	man1/flux-account-pop-db.1 \
	man1/flux-account-export-db.1 \
	man1/flux-account-view-user.1 \
	man1/flux-account-add-user.1 \
	man1/flux-account-delete-user.1 \
	man1/flux-account-edit-user.1 \
	man1/flux-account-view-bank.1 \
	man1/flux-account-add-bank.1 \
	man1/flux-account-delete-bank.1 \
	man1/flux-account-edit-bank.1 \
	man1/flux-account-list-banks.1 \
	man1/flux-account-view-queue.1 \
	man1/flux-account-add-queue.1 \
	man1/flux-account-delete-queue.1 \
	man1/flux-account-edit-queue.1 \
	man1/flux-account-list-queues.1 \
	man1/flux-account-list-users.1 \
	man1/flux-account-add-project.1 \
	man1/flux-account-view-project.1 \
	man1/flux-account-delete-project.1 \
	man1/flux-account-list-projects.1 \
	man1/flux-account-view-factor.1 \
	man1/flux-account-edit-factor.1 \
	man1/flux-account-list-factors.1 \
	man1/flux-account-reset-factors.1 \
	man1/flux-account-jobs.1 \
	man1/flux-account-view-job-records.1 \
	man1/flux-account-show-usage.1 \
	man1/flux-account-edit-all-users.1

RST_FILES  = \
	$(MAN1_FILES_PRIMARY:.1=.rst)

if ENABLE_DOCS
man_MANS = $(MAN1_FILES)
endif

SUFFIXES = .rst .1

sphinx_man = $(sphinx_man_$(V))
sphinx_man_ = $(sphinx_man_$(AM_DEFAULT_VERBOSITY))
sphinx_man_0 = @echo "  BUILD     manpages";

sphinx_html = $(sphinx_html_$(V))
sphinx_html_ = $(sphinx_html_$(AM_DEFAULT_VERBOSITY))
sphinx_html_0 = @echo "  BUILD     html";

sphinx_verbose_flags = $(sphinx_verbose_flags_$(V))
sphinx_verbose_flags_ = $(sphinx_verbose_flags_$(AM_DEFAULT_VERBOSITY))
sphinx_verbose_flags_0 =
sphinx_verbose_flags_1 = -v
sphinx_verbose_flags_2 = -vv

STDERR_DEVNULL = $(stderr_devnull_$(V))
stderr_devnull_ =  $(stderr_devnull_$(AM_DEFAULT_VERBOSITY))
stderr_devnull_0 = >/dev/null 2>&1

$(MAN_FILES): manpages.py conf.py $(RST_FILES)
	$(sphinx_man) \
	SPHINX_BUILDDIR=$(abs_builddir) $(PYTHON) \
		-m sphinx $(sphinx_verbose_flags) -b man $(srcdir) ./man \
		$(STDERR_DEVNULL)
	@echo "  MV        manpages"; \
	for sec in 1; do \
	  $(MKDIR_P) man$$sec && \
	  mv -f $(abs_builddir)/man/*.$$sec man$$sec/; \
	done

.PHONY: html
html: conf.py $(RST_FILES)
	$(sphinx_html) \
	SPHINX_BUILDDIR=$(abs_builddir) $(PYTHON) \
		-m sphinx $(sphinx_verbose_flags) -b html $(srcdir) ./html \
		$(STDERR_DEVNULL)

EXTRA_DIST = \
	conf.py \
	manpages.py \
	index.rst \
	domainrefs.py \
	requirements.txt \
	guide/accounting-guide.rst \
	guide/sanity-checklist.rst \
	guide/troubleshooting-guide.rst \
	images/lgplv3-147x51.png \
	images/flux-accounting-db.png \
	images/flux-accounting-service.png \
	images/priority-update.png \
	images/update-usage-and-fshare.png \
	components/database-administration.rst \
	components/fair-share.rst \
	components/job-usage-calculation.rst \
	components/projects.rst \
	components/limits.rst \
	components/job-priorities.rst \
	components/module-structure.rst \
	$(RST_FILES) \
	man1/index.rst

CLEANFILES = \
	$(MAN_FILES)

clean-local:
	-rm -rf man python/autogenerated

distclean-local:
	-rm -rf doctrees

AM_LDFLAGS = \
	$(CODE_COVERAGE_LIBS) \
	-no-install

AM_CPPFLAGS = \
	-I$(top_srcdir) \
	-I$(top_srcdir)/src/include \
	-I$(top_builddir)/src/common/libflux
